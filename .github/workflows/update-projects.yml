name: è‡ªåŠ¨æ›´æ–°é¡¹ç›®æ•°æ®

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹è¿è¡Œ (UTC+1å°æ—¶)
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'scripts/update-projects.js'
      - '.github/workflows/update-projects.yml'

jobs:
  update-projects:
    name: æ›´æ–°GitHubé¡¹ç›®æ•°æ®
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ›´æ–°é¡¹ç›®æ•°æ®
        run: node scripts/update-projects.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°é¡¹ç›®æ•°æ®æ›´æ–°"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ–°"
          fi

      - name: æäº¤æ›´æ–°
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add src/data/projects.json
          git diff --cached --stat
          git commit -m "$(cat <<'EOF'
è‡ªåŠ¨æ›´æ–°GitHubé¡¹ç›®æ•°æ®

- è·å–æœ€æ–°çš„GitHubå…¬å¼€é¡¹ç›®ä¿¡æ¯
- æ™ºèƒ½åˆ†ç±»é¡¹ç›®: MCPå·¥å…·ã€AIåº”ç”¨ã€ç§‘ç ”å·¥å…·ã€Webå¼€å‘ç­‰
- æ›´æ–°æ˜Ÿæ ‡æ•°ã€Forkæ•°ç­‰ç»Ÿè®¡æ•°æ®
- ä¼˜åŒ–é¡¹ç›®å±•ç¤ºé¡ºåº

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: GitHub Action <action@github.com>
EOF
)"

      - name: æ¨é€æ›´æ–°
        if: steps.check-changes.outputs.changes == 'true'
        uses: actions/push@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è§¦å‘ç½‘ç«™éƒ¨ç½²
        if: steps.check-changes.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'pages.yml',
              ref: 'main'
            })