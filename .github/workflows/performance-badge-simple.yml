name: Update Performance Badge (Simple)

on:
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-badge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Lighthouse
      run: npm install -g lighthouse

    - name: Run quick performance analysis
      run: |
        lighthouse "https://home.gqy20.top" \
          --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
          --form-factor=mobile \
          --only-categories=performance \
          --output=json \
          --output-path=./lighthouse-result.json

    - name: Extract performance score
      id: extract
      run: |
        if [ -f "./lighthouse-result.json" ]; then
          SCORE=$(cat ./lighthouse-result.json | jq -r '.categories.performance.score * 100 | floor')
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Performance score: $SCORE"
        else
          echo "No performance report found"
          exit 1
        fi

    - name: Generate badge color
      id: color
      run: |
        SCORE="${{ steps.extract.outputs.score }}"
        if [ "$SCORE" -ge 90 ]; then
          COLOR="brightgreen"
          STATUS="Excellent"
        elif [ "$SCORE" -ge 70 ]; then
          COLOR="yellow"
          STATUS="Good"
        elif [ "$SCORE" -ge 50 ]; then
          COLOR="orange"
          STATUS="Fair"
        else
          COLOR="red"
          STATUS="Poor"
        fi

        echo "color=$COLOR" >> $GITHUB_OUTPUT
        echo "status=$STATUS" >> $GITHUB_OUTPUT

    - name: Update README with badge
      run: |
        SCORE="${{ steps.extract.outputs.score }}"
        COLOR="${{ steps.color.outputs.color }}"
        STATUS="${{ steps.color.outputs.status }}"

        BADGE_URL="https://img.shields.io/badge/Performance-$SCORE%2F100-$COLOR"
        BADGE_MARKDOWN="![Performance]($BADGE_URL)"

        # Read current README
        README_CONTENT=$(cat README.md)

        # Check if performance badge exists
        if echo "$README_CONTENT" | grep -q "Performance.*shields.io"; then
          # Update existing badge
          NEW_CONTENT=$(echo "$README_CONTENT" | sed "s|!\[Performance\](https://img\.shields\.io/badge/Performance-[^)]*)|$BADGE_MARKDOWN|")
        else
          # Add new badge after the first title
          NEW_CONTENT=$(echo "$README_CONTENT" | sed "2i\\
$BADGE_MARKDOWN
")
        fi

        echo "$NEW_CONTENT" > README.md

        echo "README.md updated with performance badge: $SCORE/100 ($STATUS)"

    - name: Create performance data file
      run: |
        SCORE="${{ steps.extract.outputs.score }}"
        COLOR="${{ steps.color.outputs.color }}"
        STATUS="${{ steps.color.outputs.status }}"
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

        cat > performance-badge.json << EOF
        {
          "score": $SCORE,
          "color": "$COLOR",
          "status": "$STATUS",
          "timestamp": "$TIMESTAMP",
          "badgeUrl": "https://img.shields.io/badge/Performance-$SCORE%2F100-$COLOR"
        }
        EOF

    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add README.md performance-badge.json

        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update performance badge: ${{ steps.extract.outputs.score }}/100 - ${{ steps.color.outputs.status }} [automated]"
          git push
        fi

    - name: Display summary
      run: |
        echo "## ðŸš€ Performance Badge Updated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Score | ${{ steps.extract.outputs.score }}/100 | ${{ steps.color.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Color | ${{ steps.color.outputs.color }} | Badge Generated |" >> $GITHUB_STEP_SUMMARY